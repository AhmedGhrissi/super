spring:
  application:
    name: machine-monitor
    version: 1.0.0

  profiles:
    active: dev
    include: security,monitoring

  # Configuration par défaut (commun à tous les environnements)
  datasource:
    url: jdbc:mysql://localhost:3306/machine_monitor?useUnicode=true&characterEncoding=UTF-8&useSSL=false&allowPublicKeyRetrieval=true&autoReconnect=true&serverTimezone=Europe/Paris
    username: monitor_user
    password: Monitor123!
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      auto-commit: false
      connection-timeout: 30000

  jpa:
    hibernate:
      ddl-auto: validate
    open-in-view: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQLDialect
        connection:
          provider_disables_autocommit: true
        jdbc:
          batch_size: 20
        order_updates: true
        order_inserts: true

  # === CONFIGURATION JSP ===
  mvc:
    view:
      prefix: /WEB-INF/views/
      suffix: .jsp
  web:
    resources:
      static-locations: classpath:/static/

  # Désactiver Thymeleaf pour éviter les conflits
  thymeleaf:
    enabled: false
    cache: false

  # === CONFIGURATION EMAIL ===
  mail:
    host: smtp.ethereal.email
    port: 587
    username: ben.fahey@ethereal.email
    password: YcpjMswFg2uZ4vGbPy
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
          connectiontimeout: 5000
          timeout: 5000
          writetimeout: 5000
        debug: false

  transaction:
    default-timeout: 30
    rollback-on-commit-failure: true

  # Configuration sécurité pour le développement
  security:
    filter:
      dispatcher-types: async,error,request

# Configuration de l'application
app:
  chrome-devtools:
    enabled: true
    environment: dev
    web-url: http://localhost:8080

  # Configuration existante ALERTES
  alert:
    seuil-disponibilite: 80.0
    emails-destinataires: "ben.fahey@ethereal.email"
    rapport-heure: 8

  monitoring:
    intervalle-verification: "0 */5 * * * *"
    timeout-test: 5000

# Configuration serveur
server:
  port: 8080
  servlet:
    encoding:
      charset: UTF-8
      enabled: true
      force: true
    session:
      timeout: 30m
      cookie:
        http-only: true
        secure: false
        same-site: lax

  # Compression pour les performances
  compression:
    enabled: true
    mime-types: text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json
    min-response-size: 1024

  # Tomcat configuration
  tomcat:
    max-threads: 200
    min-spare-threads: 10
    connection-timeout: 5000
    max-connections: 10000
    accept-count: 100
    max-http-form-post-size: 10MB

# Configuration Spring Boot Actuator
management:
  endpoints:
    web:
      exposure:
        include: health,metrics,info,prometheus
      base-path: /monitoring
      cors:
        allowed-origins: "http://localhost:8080"
        allowed-methods: "GET,POST"
    enabled-by-default: true
  endpoint:
    health:
      show-details: always
      show-components: always
    prometheus:
      enabled: true
    info:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
    distribution:
      percentiles-histogram:
        http.server.requests: true
    enable:
      jvm: true
      system: true
      logback: true

# INFO ENDPOINT CONFIGURATION
info:
  app:
    name: "${spring.application.name}"
    version: "${spring.application.version}"
    description: "Système de monitoring des machines et caisses - Crédit Agricole"
  environment: "${spring.profiles.active}"
  contact:
    email: "support@credit-agricole.com"
    team: "GEID Supervision"

logging:
  level:
    # Spring Framework
    org.springframework: INFO
    org.springframework.security: DEBUG
    org.springframework.web.servlet: DEBUG
    org.springframework.web.servlet.view.JstlView: DEBUG
    org.springframework.web.servlet.view.UrlBasedViewResolver: DEBUG

    # Hibernate/JPA
    org.hibernate: INFO
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE

    # Application
    com.example.monitor: INFO
    com.example.monitor.controller: DEBUG
    com.example.monitor.controller.LoginController: DEBUG
    com.example.monitor.service: INFO
    com.example.monitor.service.EmailService: DEBUG
    com.example.monitor.config: DEBUG

    # Chrome DevTools
    com.esm.machineMonitor.controller.ChromeDevToolsController: DEBUG

    # Apache Commons
    org.apache.catalina.core.ContainerBase: ERROR

  # Configuration des fichiers de log
  file:
    name: logs/machine-monitor.log
    max-size: 10MB
    max-history: 30
    total-size-cap: 100MB

  # Configuration console
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %highlight(%-5level) - %cyan(%logger{36}) - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# Configuration CORS globale
cors:
  allowed-origins: "http://localhost:8080"
  allowed-methods: "GET,POST,PUT,DELETE,OPTIONS"
  allowed-headers: "*"
  allow-credentials: true

# Configuration JSP
jsp:
  servlet:
    init-parameters:
      development: true
      checkInterval: 0

---
# Profil dev
spring:
  config:
    activate:
      on-profile: dev

  jpa:
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        use_sql_comments: true

  datasource:
    hikari:
      maximum-pool-size: 5
      minimum-idle: 2
      idle-timeout: 300000
      max-lifetime: 1800000

  cache:
    type: simple
    cache-names: users,config,cache

  # Configuration serveur pour dev
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 10MB

# Configuration dev management
management:
  endpoints:
    web:
      exposure:
        include: "*"
      cors:
        allowed-origins: "*"
  endpoint:
    health:
      show-details: always
    shutdown:
      enabled: true

# Logging dev
logging:
  level:
    com.example.monitor: DEBUG
    org.springframework.security: TRACE
    org.springframework.web: DEBUG
    org.springframework.transaction: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
    org.hibernate.stat: DEBUG
    org.hibernate.cache: DEBUG

---
# Profil prod
spring:
  config:
    activate:
      on-profile: prod

  jpa:
    show-sql: false
    properties:
      hibernate:
        format_sql: false
        use_sql_comments: false

  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      idle-timeout: 600000
      max-lifetime: 3600000

  cache:
    type: caffeine
    caffeine:
      spec: maximumSize=500,expireAfterWrite=600s
    cache-names: users,config,cache,sessions

  # Configuration serveur pour prod
  servlet:
    multipart:
      max-file-size: 50MB
      max-request-size: 50MB

  # Désactiver JSP cache en prod
  mvc:
    view:
      prefix: /WEB-INF/views/
      suffix: .jsp
  web:
    resources:
      static-locations: classpath:/static/,classpath:/public/,classpath:/resources/,classpath:/META-INF/resources/
      cache:
        period: 31536000 # 1 an en secondes
      chain:
        cache: true
        compressed: true
        strategy:
          content:
            enabled: true
            paths: /**

# Configuration prod management
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
      cors:
        allowed-origins: "https://prod-domain.com"
    enabled-by-default: false
  endpoint:
    health:
      show-details: when-authorized
      roles: "ADMIN,SUPERVISEUR"
    shutdown:
      enabled: false

# Logging prod
logging:
  level:
    com.example.monitor: INFO
    org.springframework.security: WARN
    org.springframework.web: INFO
    org.hibernate.SQL: WARN
    org.hibernate.type.descriptor.sql.BasicBinder: OFF
  file:
    name: /var/log/machine-monitor/app.log
    max-size: 50MB
    max-history: 60
    total-size-cap: 1GB
  logback:
    rollingpolicy:
      clean-history-on-start: true

# Configuration SSL pour prod (optionnel)
server:
  ssl:
    enabled: true
    key-store: classpath:keystore.p12
    key-store-password: changeit
    key-store-type: PKCS12
    key-alias: tomcat
  forward-headers-strategy: framework